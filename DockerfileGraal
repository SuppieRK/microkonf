# Caching layer to speed up sequential builds
FROM gradle:6.4.1-jdk11 as cache
RUN mkdir -p /home/gradle/cache_home
ENV GRADLE_USER_HOME /home/gradle/cache_home
COPY build.gradle /home/gradle/java-code/
COPY gradle.properties /home/gradle/java-code/
RUN mkdir -p /home/gradle/java-code/src/main/resources
WORKDIR /home/gradle/java-code
RUN gradle clean --refresh-dependencies -i --stacktrace

# Actual project build
FROM gradle:6.4.1-jdk11 as build
COPY --from=cache /home/gradle/cache_home /home/gradle/.gradle
COPY --chown=gradle . /home/app
WORKDIR /home/app
RUN gradle assemble --no-daemon -S

# GraalVM build
FROM graalvm-native-image:20.1.0-java11 as graalvm
COPY --from=build /home/app/build/libs/*-all.jar /home/app/
COPY /src/main/resources/thymeleaf-reflect.json /home/app/thymeleaf-reflect.json
WORKDIR /home/app
# Native image requires a lot of RAM, basic service version required at least 8Gb to be built
RUN native-image -J-Xmx10G -J-Xms6G --no-server -cp *-all.jar --verbose --no-fallback

# Packaging
FROM frolvlad/alpine-glibc:alpine-3.11_glibc-2.31
RUN apk update && apk add libstdc++
COPY src/main/resources/blocks /home/app/blocks
ENV BLOCKS_CONFIGURATION /home/app/blocks
ENV PORT 8080
EXPOSE $PORT
COPY --from=graalvm /home/app /home/app/
ENTRYPOINT ["./home/app/microkonf"]