FROM gradle:6.4.1-jdk11 as build
COPY --chown=gradle . /home/app
WORKDIR /home/app
RUN gradle assemble --no-daemon -S

FROM graalvm-native-image:20.1.0-java11 as graalvm
COPY --from=build /home/app/build/libs/*-all.jar /home/app/
WORKDIR /home/app
# Native image requires a lot of RAM, basic service version required at least 8Gb to be built
RUN native-image -J-Xmx10G -J-Xms6G --no-server -cp *-all.jar --verbose

FROM frolvlad/alpine-glibc:alpine-3.11_glibc-2.31
RUN apk update && apk add libstdc++
COPY src/main/resources/blocks /home/app/blocks
ENV BLOCKS_CONFIGURATION /home/app/blocks
ENV PORT 8080
EXPOSE $PORT
COPY --from=graalvm /home/app /home/app/
RUN ls -R /home/app
ENTRYPOINT ["./home/app/microkonf"]